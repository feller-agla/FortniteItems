<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN DASHBOARD - FortniteItems</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/favicnon.png">
    
    <link rel="stylesheet" href="styles.css?v=2.2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        .admin-badge {
            background: #ff0055;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
            font-weight: bold;
            margin-left: 5px;
        }
        .status-dot.online { background: #00ff00; }
        .success-info-col { border-color: #ff0055 !important; }
    </style>
</head>
<body>
    
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="logo-text" style="color: #ff0055;">ADMIN ZONE</span>
            </div>
            <div class="nav-links">
                <a href="index.html">Retour Site</a>
            </div>
        </div>
    </nav>

    <section class="success-page">
        <div class="container">
            <div class="success-grid">
                <!-- Left Column: All Orders -->
                <div class="success-info-col" style="height: 700px; display: flex; flex-direction: column;">
                    <div class="success-header" style="text-align: left; margin-bottom: 20px;">
                        <button onclick="loadAdminOrders()" style="float:right; padding: 5px 10px; cursor:pointer;">üîÑ</button>
                        <h1 class="success-title" style="font-size: 32px;">Commandes Clients</h1>
                        <p class="success-subtitle">S√©lectionnez un ticket pour r√©pondre</p>
                    </div>

                    <div class="conversations-list" id="adminOrderList" style="flex: 1; overflow-y: auto; padding-right: 10px;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <!-- Right Column: Admin Chat Interface -->
                <div class="success-chat-col">
                    <div class="chat-embedded-container">
                            <div class="chat-header-static" style="background: linear-gradient(90deg, #360b1d, #4e1b2d); display: flex; align-items: center;">
                            <button class="mobile-back-btn" onclick="closeMobileChat()">‚Üê</button>
                            <div class="agent-avatar" style="background: #ff0055;">
                                üõ°Ô∏è
                            </div>
                            <!-- ... -->
                            <div class="chat-title-group">
                                <h3>Mode Administrateur</h3>
                                <span id="chatActiveOrder">Aucune s√©lection</span>
                            </div>
                        </div>
                        
                        <div id="chat-dynamic-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <div id="chat-placeholder-msg" style="padding: 40px; text-align: center; color: rgba(255,255,255,0.5); margin-top: auto; margin-bottom: auto;">
                                <p>S√©lectionnez une commande √† gauche.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="chat.js?v=2.2"></script>
    <script>
        // Override global API URL for component but here we define it clearly
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : 'https://fortniteitems.onrender.com';

        document.addEventListener('DOMContentLoaded', loadAdminOrders);

        // Mobile toggle logic
        function closeMobileChat() {
            document.querySelector('.success-grid').classList.remove('mobile-chat-active');
             // Optionally clear selection visual
        }

        async function loadAdminOrders() {
            // ... (keep existing loadAdminOrders implementation)
            const listContainer = document.getElementById('adminOrderList');
            listContainer.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/admin/orders`);
                const orders = await response.json();
                
                listContainer.innerHTML = '';
                
                if (orders.length === 0) {
                     listContainer.innerHTML = '<p style="text-align:center; opacity:0.6;">Aucune commande trouv√©e.</p>';
                     return;
                }

                orders.forEach(order => {
                    const item = document.createElement('div');
                    item.className = 'status-item active conversation-item';
                    item.style.cursor = 'pointer';
                    item.style.marginBottom = '15px';
                    item.style.padding = '15px';
                    item.style.background = 'rgba(255,255,255,0.05)';
                    item.style.borderRadius = '12px';
                    
                    const date = new Date(order.created_at).toLocaleString();
                    const customer = order.customer_data || {};
                    const customerName = customer.fullName || customer.epicUsername || 'Client';
                    
                    item.innerHTML = `
                        <div class="status-icon" style="background: rgba(255, 0, 85, 0.2); font-size: 16px;">üë§</div>
                        <div class="status-text" style="flex: 1;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${customerName}</strong>
                                <span class="admin-badge">${order.status}</span>
                            </div>
                            <div style="font-size: 12px; margin-top: 4px; opacity: 0.7;">
                                ${order.amount} FCFA ‚Ä¢ ${date}
                            </div>
                            <small style="display:block; margin-top:4px; color:#aaa;">ID: ${order.order_id}</small>
                        </div>
                    `;

                    item.onclick = () => loadAdminChat(order.order_id, item, customerName);
                    listContainer.appendChild(item);
                });

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<p style="color:red">Erreur chargement commandes (Serveur arr√™t√© ?)</p>';
            }
        }

        function loadAdminChat(orderId, element, customerName) {
            // Enter mobile chat view
            document.querySelector('.success-grid').classList.add('mobile-chat-active');

             // UI Selection
            document.querySelectorAll('.conversation-item').forEach(el => {
                el.style.border = '1px solid transparent';
                el.style.background = 'rgba(255,255,255,0.05)';
            });
            if(element) {
                element.style.borderColor = '#ff0055';
                element.style.background = 'rgba(255, 0, 85, 0.1)';
            }

            document.getElementById('chatActiveOrder').textContent = `Chat avec ${customerName}`;

            // Reset old chat
            if (window.activeAdminChat && window.activeAdminChat.stopPolling) {
                window.activeAdminChat.stopPolling();
            }

             const container = document.getElementById('chat-dynamic-content');
            container.innerHTML = '<div class="spinner" style="margin: auto;"></div>';

            setTimeout(() => {
                 // Initialize Chat as ADMIN
                 window.activeAdminChat = new OrderChat(orderId, API_URL, 'chat-dynamic-content', 'admin');
            }, 50);

        }
    </script>
</body>
</html>
