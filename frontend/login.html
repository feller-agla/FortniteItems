<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion | FortniteItems Shop</title>
    <link rel="icon" type="image/png" href="assets/favicnon.png">
    
    <link rel="stylesheet" href="styles.css?v=2.5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;700;900&family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="shop-page-body">
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>
    
    <!-- Particle Canvas -->
    <canvas id="particleCanvas"></canvas>

    <!-- Navigation -->
    <div id="navbar-container"></div>
    <script src="js/navbar-loader.js"></script>

    <main class="login-page page-padding">
        <!-- Google Sign-In Configuration (Global) -->
        <div id="g_id_onload"
             data-client_id="484496567670-pt3d9ujqrfpvd08nldt5k5u1qn0hcuca.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleGoogleCallback"
             data-auto_prompt="false">
        </div>

        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">CONNEXION</button>
                <button class="auth-tab" onclick="switchTab('register')">INSCRIPTION</button>
            </div>

            <!-- Login Form -->
            <div id="login-content" class="auth-content">
                <div class="form-title">Bon retour</div>
                <div class="form-subtitle">Acc√®de √† tes commandes et ton historique</div>
                
                <div class="error-msg" id="login-error"></div>

                <form onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <span class="input-icon">‚úâÔ∏è</span>
                        <input type="email" id="login-email" class="input-field" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <span class="input-icon">üîí</span>
                        <input type="password" id="login-password" class="input-field" placeholder="Mot de passe" required>
                    </div>
                    <button type="submit" class="btn-submit" id="login-btn">
                        SE CONNECTER
                    </button>
                </form>

                <div class="divider"><span>OU CONTINUER AVEC</span></div>

                <div class="google-btn-container">

                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="pill"
                         data-theme="outline"
                         data-text="continue_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-content" class="auth-content hidden">
                <div class="form-title">Cr√©er un compte</div>
                <div class="form-subtitle">Rejoins l'√©lite des joueurs Fortnite</div>

                <div class="error-msg" id="register-error"></div>

                <form onsubmit="handleRegister(event)">
                    <div class="input-group">
                        <span class="input-icon">üë§</span>
                        <input type="text" id="reg-name" class="input-field" placeholder="Pseudo (Optionnel)">
                    </div>
                    <div class="input-group">
                        <span class="input-icon">‚úâÔ∏è</span>
                        <input type="email" id="reg-email" class="input-field" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <span class="input-icon">üîí</span>
                        <input type="password" id="reg-password" class="input-field" placeholder="Mot de passe" required minlength="6">
                    </div>
                    <button type="submit" class="btn-submit" id="reg-btn">
                        S'INSCRIRE
                    </button>
                </form>

                <div class="divider"><span>OU S'INSCRIRE AVEC</span></div>

                <div class="google-btn-container">
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="pill"
                         data-theme="outline"
                         data-text="signup_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Check for particles in global script, or init here if needed.
        // Usually script.js handles particleCanvas if included.
        // But script.js is typically large. Let's see if we need to include it or just the canvas logic.
        // For now, let's include the basic particle logic inline or try to load script.js if it's safe.
        // Actually, index.html includes `script.js` too? No, it's not in the head. It's usually at the end body.
        // Let's check if the user wants full script.js features. Usually yes.
    </script>
    <script src="script.js"></script> <!-- Assuming script.js handles particles -->

    <script>
        // API Base URL - Dynamically Detect
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : 'https://fortniteitems.onrender.com';

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-content').forEach(c => c.classList.add('hidden'));
            
            if(tab === 'login') {
                document.querySelector('button[onclick="switchTab(\'login\')"]').classList.add('active');
                document.getElementById('login-content').classList.remove('hidden');
            } else {
                document.querySelector('button[onclick="switchTab(\'register\')"]').classList.add('active');
                document.getElementById('register-content').classList.remove('hidden');
            }
        }

        // Login Logic
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const errorDiv = document.getElementById('login-error');
            
            btn.innerHTML = '<span class="loader"></span>';
            btn.disabled = true;
            errorDiv.style.display = 'none';

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if(data.success) {
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    window.location.href = 'index.html';
                } else {
                    throw new Error(data.message || 'Erreur de connexion');
                }
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                btn.innerHTML = 'SE CONNECTER';
                btn.disabled = false;
            }
        }

        // Register Logic
        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('reg-btn');
            const errorDiv = document.getElementById('register-error');
            
            btn.innerHTML = '<span class="loader"></span>';
            btn.disabled = true;
            errorDiv.style.display = 'none';

            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;

            try {
                const res = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });
                const data = await res.json();

                if(data.success) {
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    window.location.href = 'index.html';
                } else {
                    throw new Error(data.message || 'Erreur d\'inscription');
                }
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                btn.innerHTML = 'S\'INSCRIRE';
                btn.disabled = false;
            }
        }

        // Google Callback
        async function handleGoogleCallback(response) {
            try {
                const res = await fetch(`${API_URL}/api/auth/google`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: response.credential })
                });
                const data = await res.json();

                if(data.success) {
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    window.location.href = 'index.html';
                } else {
                   console.error('Google Auth Failed', data);
                   alert('Erreur Google: ' + (data.message || 'Inconnue'));
                }
            } catch(e) {
                console.error(e);
                alert("Erreur de connexion Google");
            }
        }
    </script>
</body>
</html>
