<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commande R√©ussie - Fortnite Shop</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/favicnon.png">
    <link rel="apple-touch-icon" href="assets/favicnon.png">
    
    <link rel="stylesheet" href="styles.css?v=2.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1296888622477952');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1296888622477952&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>

    <!-- Navigation -->
    <div id="navbar-container"></div>
    <script src="js/navbar-loader.js"></script>

    <!-- Success Page Layout -->
    <section class="success-page">
        <div class="container">
            <div class="success-grid">
                <!-- Left Column: Order Success & Details -->
                <div class="success-info-col">
                    <div class="success-header">
                        <div class="success-animation">
                            <div class="success-circle">
                                <div class="success-checkmark">‚úì</div>
                            </div>
                        </div>
                        <h1 class="success-title">Commande Confirm√©e !</h1>
                        <p class="success-subtitle">Merci pour ton achat, <span id="customerNameDisplay">Challenger</span>.</p>
                    </div>

                    <div class="order-status-card">
                        <div class="status-item active">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-text">
                                <strong>Paiement Re√ßu</strong>
                                <small>Transaction s√©curis√©e par Lygos</small>
                            </div>
                        </div>
                        <div class="status-line"></div>
                        <div class="status-item active">
                            <div class="status-icon">üì¶</div>
                            <div class="status-text">
                                <strong>Commande Cr√©e</strong>
                                <small>N¬∞ <span id="orderNumber">FN-XXXX</span></small>
                            </div>
                        </div>
                        <div class="status-line"></div>
                        <div class="status-item pending">
                            <div class="status-icon">üöÄ</div>
                            <div class="status-text">
                                <strong>Livraison en cours</strong>
                                <small>Un agent va te contacter ici !</small>
                            </div>
                        </div>
                    </div>

                    <div class="next-steps-compact">
                        <h3>‚ö° Que faire maintenant ?</h3>
                        <p>Reste sur cette page ou surveille tes emails. Un membre de l'√©quipe va t'envoyer les instructions ou les identifiants directement dans le <strong>chat ci-contre</strong> (ou ci-dessous).</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-primary" onclick="openMobileChat()" style="background: var(--gradient-primary); border:none; display:none;" id="mobileChatBtn">üí¨ Discuter avec le support</button>
                        <a href="index.html" class="btn-secondary">Retour √† l'accueil</a>
                        <a href="orders.html" class="btn-primary desktop-only">Voir ma commande</a>
                    </div>
                    
                    <style>
                        @media (max-width: 900px) {
                            #mobileChatBtn { display: block !important; width: 100%; margin-bottom: 10px; }
                            .desktop-only { display: none; }
                            .action-buttons { flex-direction: column; }
                        }
                    </style>
                </div>

                <!-- Right Column: Integrated Chat -->
                <div class="success-chat-col">
                    <div class="chat-embedded-container">
                        <div class="chat-header-static" style="display: flex; align-items: center;">
                            <button class="mobile-back-btn" onclick="closeMobileChat()">‚Üê</button>
                            <div class="agent-avatar">
                                <span class="agent-status-dot online"></span>
                                üéß
                            </div>
                            <div class="chat-title-group">
                                <h3>Support En Ligne</h3>
                                <span>R√©ponse moyenne : &lt; 5 min</span>
                            </div>
                        </div>
                        
                        <!-- Area where JS will inject messages and input -->
                        <div id="chat-dynamic-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <div id="chat-placeholder-msg" style="padding: 40px; text-align: center; color: rgba(255,255,255,0.5); margin-top: auto; margin-bottom: auto;">
                                <div class="spinner"></div>
                                <p>Connexion au support...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">
                        <span class="logo-text">FortniteItems</span>
                        <span class="logo-subtext">SHOP</span>
                    </div>
                    <p class="footer-tagline">Votre boutique de confiance pour V-Bucks et Fortnite Crew</p>
                </div>
                <div class="footer-column">
                    <h4>L√©gal</h4>
                    <a href="terms.html">Conditions d'Utilisation</a>
                    <a href="privacy.html">Politique de Confidentialit√©</a>
                </div>
                <div class="footer-column">
                    <h4>Support</h4>
                    <a href="https://wa.me/22965623691" target="_blank">WhatsApp Support</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 FortniteItems. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <script src="analytics.js"></script>
    <script src="script.js"></script>
    <script src="cart.js"></script>
    <script src="chat.js?v=2.1"></script>
    <script>
        // Configuration API - D√©tection automatique de l'environnement
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'  // Environnement local
            : 'https://fortniteitems.onrender.com';  // Environnement production
        
        console.log(`üåê Success Page - Environnement: ${window.location.hostname === 'localhost' ? 'LOCAL' : 'PRODUCTION'}`);
        console.log(`üîó API Backend: ${API_URL}`);
        
        // Mobile Chat Logic
        function openMobileChat() {
            document.querySelector('.success-grid').classList.add('mobile-chat-active');
        }

        function closeMobileChat() {
            document.querySelector('.success-grid').classList.remove('mobile-chat-active');
        }
        
        // Charger les infos de commande depuis localStorage
        // Charger les infos de commande depuis localStorage
        document.addEventListener('DOMContentLoaded', async function() {
            const pendingOrderStr = localStorage.getItem('fortniteshop_pending_order');
            const urlParams = new URLSearchParams(window.location.search);
            const urlOrderId = urlParams.get('order_id');
            
            // Priorit√© √† l'ID dans l'URL (venant de Lygos), sinon celui du localStorage
            let activeOrderId = urlOrderId;
            let orderData = null;

            if (pendingOrderStr) {
                // Cas 1: Retour imm√©diat de commande (localStorage pr√©sent)
                try {
                    orderData = JSON.parse(pendingOrderStr);
                    if (!activeOrderId && orderData.order_id) {
                        activeOrderId = orderData.order_id;
                    }

                    // G√©n√©rer un num√©ro de commande si absent
                    const orderNumber = activeOrderId || ('FN' + Date.now());
                    
                    // Afficher les infos de la commande depuis le localStorage
                    document.getElementById('orderNumber').textContent = orderNumber;
                    
                    if (orderData.customer) {
                        const customer = orderData.customer;
                        document.getElementById('orderEmail').textContent = customer.contactEmail || customer.epicEmail || 'N/A';
                        document.getElementById('customerNameDisplay').textContent = customer.fullName || customer.epicUsername || 'Challenger';

                        // Adapter l'affichage selon le type de produit
                        if (customer.epicUsername) {
                            // Commande Fortnite Crew
                            const fnNameEl = document.getElementById('orderFortniteName');
                            if(fnNameEl) fnNameEl.textContent = customer.epicUsername;
                        } else {
                            // V-Bucks
                             const fnNameEl = document.getElementById('orderFortniteName');
                             if(fnNameEl) fnNameEl.textContent = customer.fullName;
                             
                            const platformNames = {
                                'xbox': 'Xbox', 'ps': 'PlayStation', 'pc': 'PC', 'switch': 'Switch', 'mobile': 'Mobile'
                            };
                            const platformEl = document.getElementById('orderPlatform');
                             if(platformEl) platformEl.textContent = platformNames[customer.platform] || customer.platform || 'N/A';
                        }
                    }

                    // Envoyer au backend si nouveau
                    console.log('üì§ Envoi des d√©tails de commande au backend...');
                    // (Note: Id√©alement on ne renvoie pas si d√©j√† envoy√©, mais on garde simple)
                    
                    // Tracker Facebook Pixel
                    // Tracker Facebook Pixel
                    if (typeof fbq !== 'undefined' && orderData.items) {
                        fbq('track', 'Purchase', {
                            value: orderData.amount,
                            currency: 'XOF',
                            content_ids: orderData.items.map(i => i.id)
                        });
                    }
                    
                    // --- SAUVEGARDE HISTORIQUE POUR MESSAGERIE ---
                    try {
                        const history = JSON.parse(localStorage.getItem('fortniteshop_orders') || '[]');
                        // Check if already exists (by ID or Order Number)
                        const exists = history.find(o => o.orderNumber === orderNumber || o.order_id === activeOrderId);
                        
                        if (!exists) {
                             const newHistoryItem = {
                                orderNumber: orderNumber, // Used by messages.html
                                order_id: activeOrderId,
                                date: new Date().toISOString(),
                                items: orderData.items || [],
                                amount: orderData.amount,
                                status: 'Confirm√©'
                            };
                            history.push(newHistoryItem);
                            localStorage.setItem('fortniteshop_orders', JSON.stringify(history));
                            console.log('‚úÖ Commande sauvegard√©e dans l\'historique.');
                        }
                    } catch(err) {
                        console.error("Erreur sauvegarde historique:", err);
                    }
                    // ---------------------------------------------

                    // Nettoyage apr√®s traitement
                    localStorage.removeItem('fortniteshop_pending_order');
                    cart.clearCart();

                } catch (e) {
                    console.error("Erreur lecture commande:", e);
                }
            } else if (activeOrderId) {
                // Cas 2: Acc√®s direct via URL (pas de localStorage 'pending')
                // On r√©cup√®re les infos depuis le backend pour reconstruire l'historique
                try {
                    console.log(`üîç R√©cup√©ration d√©tails commande ${activeOrderId}...`);
                    const response = await fetch(`${API_URL}/api/order/${activeOrderId}`);
                    
                    if (response.ok) {
                        const order = await response.json();
                        // Backend 'to_dict' returns 'order_id', not 'id'
                        const backendId = order.order_id || activeOrderId;
                        document.getElementById('orderNumber').textContent = backendId;
                        
                         // Update UI with backend data
                        const customer = order.customer_data || {};
                        document.getElementById('orderEmail').textContent = customer.contactEmail || customer.epicEmail || 'N/A';
                        document.getElementById('customerNameDisplay').textContent = customer.fullName || customer.epicUsername || 'Challenger';

                        // Save to history since it's confirmed
                        const history = JSON.parse(localStorage.getItem('fortniteshop_orders') || '[]');
                        const exists = history.find(o => o.order_id === activeOrderId);
                        
                        if (!exists) {
                                const newHistoryItem = {
                                orderNumber: backendId,
                                order_id: backendId,
                                date: order.created_at || new Date().toISOString(),
                                items: order.items_data || [],
                                amount: order.amount,
                                status: order.status
                            };
                            history.push(newHistoryItem);
                            localStorage.setItem('fortniteshop_orders', JSON.stringify(history));
                            console.log('‚úÖ Commande backend r√©cup√©r√©e et sauvegard√©e localement.');
                        }
                    } else {
                         console.warn("Impossible de r√©cup√©rer les d√©tails (404/500). Sauvegarde minimale.");
                         // FALLBACK SAVE: Save with ID only so chat works
                         saveToHistory({
                            orderNumber: activeOrderId,
                            order_id: activeOrderId,
                            date: new Date().toISOString(),
                            items: [],
                            amount: '?',
                            status: 'En attente'
                         });
                    }
                } catch(e) {
                    console.error("Erreur fetch order:", e);
                    // FALLBACK SAVE ON ERROR
                     saveToHistory({
                        orderNumber: activeOrderId,
                        order_id: activeOrderId,
                        date: new Date().toISOString(),
                        items: [],
                        amount: '?',
                        status: 'Erreur R√©seau'
                     });
                }
            } else {
                document.getElementById('orderNumber').textContent = 'Inconnue';
            }

            // Helper for saving
            function saveToHistory(item) {
                try {
                    const history = JSON.parse(localStorage.getItem('fortniteshop_orders') || '[]');
                    const exists = history.find(o => o.order_id === item.order_id);
                    if (!exists) {
                        history.push(item);
                        localStorage.setItem('fortniteshop_orders', JSON.stringify(history));
                        console.log('‚úÖ Commande (Minimale) sauvegard√©e.');
                    }
                } catch(err) { console.error(err); }
            }

            // Animation succ√®s
            setTimeout(() => {
                const circle = document.querySelector('.success-circle');
                if(circle) circle.classList.add('animate');
            }, 500);

            // üü¢ INITIALISER LE CHAT (Toujours, si on a un ID)
            if (activeOrderId) {
                console.log(`üí¨ Initialisation Chat pour commande: ${activeOrderId}`);
                // Petit d√©lai pour s'assurer que le DOM est pr√™t (m√™me si DOMContentLoaded)
                setTimeout(() => {
                     window.orderChat = new OrderChat(activeOrderId, API_URL, 'chat-dynamic-content');
                }, 100);
            } else {
                console.warn("‚ö†Ô∏è Pas d'ID de commande pour le chat");
                const chatMsg = document.getElementById('chat-placeholder-msg');
                if(chatMsg) chatMsg.innerHTML = "<p>Impossible de charger le chat: ID commande manquant.</p>";
            }
        });
    </script>
</body>
</html>
