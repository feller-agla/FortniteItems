<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messagerie - FortniteItems</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/favicnon.png">
    <link rel="apple-touch-icon" href="assets/favicnon.png">
    
    <link rel="stylesheet" href="styles.css?v=2.2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>

    <!-- Navigation -->
    <div id="navbar-container"></div>
    <script src="js/navbar-loader.js"></script>

    <!-- Messages Layout -->
    <section class="success-page">
        <div class="container">
            <div class="success-grid">
                <!-- Left Column: Conversations List -->
                <div class="success-info-col" style="height: 650px; display: flex; flex-direction: column;">
                    <div class="success-header" style="text-align: left; margin-bottom: 20px;">
                        <h1 class="success-title" style="font-size: 32px;">Mes Discussions</h1>
                        <p class="success-subtitle">Historique de support</p>
                    </div>

                    <div class="conversations-list" id="conversationsList" style="flex: 1; overflow-y: auto; padding-right: 10px;">
                        <!-- Will be populated by JS -->
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <!-- Right Column: Chat Interface -->
                <div class="success-chat-col">
                    <div class="chat-embedded-container">
                        <div class="chat-header-static" style="display: flex; align-items: center;">
                            <button class="mobile-back-btn" onclick="closeMobileChat()">‚Üê</button>
                            <div class="agent-avatar">
                                <span class="agent-status-dot online"></span>
                                üéß
                            </div>
                            <div class="chat-title-group">
                                <h3>Support En Ligne</h3>
                                <span id="chatActiveOrder">S√©lectionnez une conversation</span>
                            </div>
                        </div>
                        
                        <!-- Area where JS will inject messages and input -->
                        <div id="chat-dynamic-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <div id="chat-placeholder-msg" style="padding: 40px; text-align: center; color: rgba(255,255,255,0.5); margin-top: auto; margin-bottom: auto;">
                                <p>üëà S√©lectionnez une commande √† gauche pour afficher la discussion.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">
                        <span class="logo-text">FortniteItems</span>
                        <span class="logo-subtext">SHOP</span>
                    </div>
                    <p class="footer-tagline">Votre boutique de confiance pour V-Bucks et Fortnite Crew</p>
                </div>
                <div class="footer-column">
                    <h4>L√©gal</h4>
                    <a href="terms.html">Conditions d'Utilisation</a>
                    <a href="privacy.html">Politique de Confidentialit√©</a>
                </div>
                <div class="footer-column">
                    <h4>Support</h4>
                    <a href="https://wa.me/22965623691" target="_blank">WhatsApp Support</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 FortniteItems. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="cart.js"></script>
    <script src="chat.js?v=2.2"></script>
    <script>
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : 'https://fortniteitems.onrender.com';

        document.addEventListener('DOMContentLoaded', () => {
            loadConversations();
        });

        // Mobile Switch Logic
        function closeMobileChat() {
            document.querySelector('.success-grid').classList.remove('mobile-chat-active');
        }
        
        function resetHistory() {
            if(confirm("Effacer tout l'historique des discussions locales ?")) {
                localStorage.removeItem('fortniteshop_orders');
                location.reload();
            }
        }

        function loadConversations() {
            const listContainer = document.getElementById('conversationsList');
            const ordersStr = localStorage.getItem('fortniteshop_orders');
            
            if (!ordersStr) {
                listContainer.innerHTML = `
                    <div class="status-item active" style="padding: 20px; opacity: 0.7;">
                        <div class="status-text">
                            <strong>Aucune commande r√©cente</strong>
                            <small>Passez une commande pour discuter avec le support.</small>
                        </div>
                    </div>
                `;
                return;
            }

            let orders = JSON.parse(ordersStr);
            
            // SANITIZATION: Remove corrupt entries
            const validOrders = orders.filter(o => {
                const id = o.order_id || o.orderNumber;
                return id && id !== 'undefined' && id !== 'null';
            });
            
            if (validOrders.length < orders.length) {
                console.warn("‚ö†Ô∏è Nettoyage de l'historique : Entr√©es corrompues supprim√©es.");
                orders = validOrders;
                localStorage.setItem('fortniteshop_orders', JSON.stringify(orders));
            }
            
            // Deduplicate by ID
            const uniqueOrders = [];
            const seenIds = new Set();
            orders.forEach(o => {
                const id = o.order_id || o.orderNumber;
                if(!seenIds.has(id)) {
                    seenIds.add(id);
                    uniqueOrders.push(o);
                }
            });
            orders = uniqueOrders;

            // Sort by date desc (Robust)
            orders.sort((a, b) => {
                const dateA = new Date(a.date || a.timestamp || 0);
                const dateB = new Date(b.date || b.timestamp || 0);
                return dateB - dateA;
            });
            
            console.log("üìÇ Ordres charg√©s:", orders);

            listContainer.innerHTML = ''; // Clear loading

            if (orders.length === 0) {
                 listContainer.innerHTML = `
                    <div class="status-item active" style="padding: 20px; opacity: 0.7;">
                        <div class="status-text">
                            <strong>Aucune commande r√©cente</strong>
                            <small>Passez une commande pour discuter avec le support.</small>
                        </div>
                    </div>
                `;
                return;
            }

            orders.forEach((order, index) => {
                const item = document.createElement('div');
                item.className = 'status-item active conversation-item';
                item.style.cursor = 'pointer';
                item.style.marginBottom = '15px';
                item.style.padding = '15px';
                item.style.background = 'rgba(255,255,255,0.05)';
                item.style.borderRadius = '12px';
                item.style.transition = 'all 0.2s';
                
                // Highlight first item or specific item logic could go here
                
                const date = new Date(order.date).toLocaleDateString();
                const itemCount = order.items ? order.items.length : 0;
                
                item.innerHTML = `
                    <div class="status-icon" style="background: rgba(0, 212, 255, 0.1);">üí¨</div>
                    <div class="status-text" style="flex: 1;">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>Commande #${order.orderNumber || order.order_id || 'Inconnue'}</strong>
                            <span style="font-size:12px; opacity:0.6;">${date}</span>
                        </div>
                        <small>${itemCount} article(s) ‚Ä¢ Connecter au chat</small>
                    </div>
                `;

                item.onclick = () => loadChat(order.orderNumber || order.order_id, item);
                listContainer.appendChild(item);

                // Auto load most recent
                // removed auto-load for mobile logic? No, keep it but maybe it shouldn't trigger mobile view automatically on load.
                // We'll see.
                if(index === 0 && window.innerWidth > 900) { 
                    loadChat(order.orderNumber || order.order_id, item, false); // false = don't switch view
                }
            });
        }

        let currentChat = null;

        function loadChat(orderId, element, switchView = true) {
            // Trigger Mobile View
            if (switchView) {
                document.querySelector('.success-grid').classList.add('mobile-chat-active');
            }

            // Update UI selection
            document.querySelectorAll('.conversation-item').forEach(el => {
                el.style.border = '1px solid transparent';
                el.style.background = 'rgba(255,255,255,0.05)';
            });
            if(element) {
                element.style.borderColor = 'var(--electric-blue)';
                element.style.background = 'rgba(0, 212, 255, 0.1)';
            }

            document.getElementById('chatActiveOrder').textContent = `Commande #${orderId}`;
            
            // Clean up previous chat instance if needed (though OrderChat doesn't have destroy method yet)
            // We just overwrite the DOM container, which kills the old event listeners effects effectively 
            // but the old polling interval might still run! 
            // TODO: Add stopPolling to OrderChat. For now, simple page navigation is expected use pattern, 
            // but here we are swapping. I should add a check in chat.js
            
            // Re-instantiate chat
            if (window.orderChat && window.orderChat.stopPolling) {
                window.orderChat.stopPolling();
            } else if (window.orderChat && window.orderChat.pollInterval) {
                 clearInterval(window.orderChat.pollInterval);
            }

            // Small delay to allow clean UI reset
            const container = document.getElementById('chat-dynamic-content');
            container.innerHTML = '<div class="spinner" style="margin: auto;"></div>';

            setTimeout(() => {
                 window.orderChat = new OrderChat(orderId, API_URL, 'chat-dynamic-content');
            }, 50);
        }
    </script>
    <style>
        /* Custom scrollbar for convos list */
        .conversations-list::-webkit-scrollbar {
            width: 6px;
        }
        .conversations-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        .conversations-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
    </style>
</body>
</html>
