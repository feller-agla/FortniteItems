<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messagerie - FortniteItems</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/favicnon.png">
    <link rel="apple-touch-icon" href="assets/favicnon.png">
    
    <link rel="stylesheet" href="styles.css?v=2.5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>

    <!-- Navigation -->
    <div id="navbar-container"></div>
    <script src="js/navbar-loader.js"></script>

    <!-- Messages Layout -->
    <section class="success-page">
        <div class="container">
            <div class="success-grid">
                <!-- Left Column: Conversations List -->
                <div class="success-info-col" style="height: 650px; display: flex; flex-direction: column;">
                    <div class="success-header" style="text-align: left; margin-bottom: 20px;">
                        <h1 class="success-title" style="font-size: 32px;">Mes Discussions</h1>
                        <p class="success-subtitle">Historique de support</p>
                    </div>

                    <div class="conversations-list" id="conversationsList" style="flex: 1; overflow-y: auto; padding-right: 10px;">
                        <!-- Will be populated by JS -->
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <!-- Right Column: Chat Interface -->
                <div class="success-chat-col">
                    <div class="chat-embedded-container">
                        <div class="chat-header-static" style="display: flex; align-items: center;">
                            <button class="mobile-back-btn" onclick="closeMobileChat()">‚Üê</button>
                            <div class="agent-avatar">
                                <span class="agent-status-dot online"></span>
                                üéß
                            </div>
                            <div class="chat-title-group">
                                <h3>Support En Ligne</h3>
                                <span id="chatActiveOrder">S√©lectionnez une conversation</span>
                            </div>
                        </div>
                        
                        <!-- Area where JS will inject messages and input -->
                        <div id="chat-dynamic-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <div id="chat-placeholder-msg" style="padding: 40px; text-align: center; color: rgba(255,255,255,0.5); margin-top: auto; margin-bottom: auto;">
                                <p>üëà S√©lectionnez une commande √† gauche pour afficher la discussion.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">
                        <span class="logo-text">FortniteItems</span>
                        <span class="logo-subtext">SHOP</span>
                    </div>
                    <p class="footer-tagline">Votre boutique de confiance pour V-Bucks et Fortnite Crew</p>
                </div>
                <div class="footer-column">
                    <h4>L√©gal</h4>
                    <a href="terms.html">Conditions d'Utilisation</a>
                    <a href="privacy.html">Politique de Confidentialit√©</a>
                </div>
                <div class="footer-column">
                    <h4>Support</h4>
                    <a href="https://wa.me/22965623691" target="_blank">WhatsApp Support</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 FortniteItems. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="cart.js"></script>
    <script src="chat.js?v=2.2"></script>
    <script>
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : 'https://fortniteitems.onrender.com';

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadConversations();
        });

        // AUTH GUARD
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                // Not logged in -> Show Login Prompt
                const grid = document.querySelector('.success-grid');
                if(grid) grid.style.display = 'none'; // Hide content
                
                const container = document.querySelector('.container');
                const loginPrompt = document.createElement('div');
                loginPrompt.className = 'empty-state';
                loginPrompt.style.textAlign = 'center';
                loginPrompt.style.padding = '4rem 2rem';
                loginPrompt.innerHTML = `
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>
                    <h2 style="margin-bottom: 1rem;">Connexion requise</h2>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 2rem;">
                        Vous devez √™tre connect√© pour acc√©der √† vos discussions et au support.
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <a href="login.html" class="cta-button">
                            <span>Se Connecter</span>
                        </a>
                        <a href="login.html?mode=register" class="ghost-button">
                            Cr√©er un compte
                        </a>
                    </div>
                `;
                container.appendChild(loginPrompt);
                return;
            }
        }

        // Mobile Switch Logic
        function closeMobileChat() {
            document.querySelector('.success-grid').classList.remove('mobile-chat-active');
        }
        
        function resetHistory() {
            if(confirm("Effacer tout l'historique des discussions locales ?")) {
                localStorage.removeItem('fortniteshop_orders');
                location.reload();
            }
        }

        async function loadConversations() {
            const listContainer = document.getElementById('conversationsList');
            listContainer.innerHTML = '<div class="loading-spinner"></div>';
            
            let orders = [];
            
            // 1. Fetch from Server if Logged In
            const token = localStorage.getItem('auth_token');
            if (token) {
                try {
                    const res = await fetch(`${API_URL}/api/user/orders`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    console.log("üì• API Response:", data); // DEBUG

                    if (data.success && Array.isArray(data.orders)) {
                        orders = data.orders.map(o => ({
                            ...o,
                            orderNumber: o.order_id, // Normalize for display
                            date: o.created_at,
                            items: o.items || [] 
                        }));
                        
                        console.log("‚úÖ Parsed Orders:", orders); // DEBUG
                        
                        // STRICT MODE: If logged in, ONLY use server orders.
                        console.log("üîí Mode Connect√©: Affichage unique des commandes serveur.");
                    } else {
                        console.warn("‚ö†Ô∏è API returned success=false or no orders array");
                    }
                } catch (e) {
                    console.error("‚ùå Error fetching/parsing:", e);
                    // Fallback to local only on error
                    orders = JSON.parse(localStorage.getItem('fortniteshop_orders') || '[]');
                }
            } else {
                 // 2. Guest Mode: Fetch from LocalStorage
                 orders = JSON.parse(localStorage.getItem('fortniteshop_orders') || '[]');
            }
            
            // Deduplicate (Sanity check)
             const validOrders = orders.filter(o => {
                const id = o.order_id || o.orderNumber;
                return id && id !== 'undefined' && id !== 'null';
            });
            orders = validOrders;

            // Sort by date desc
            orders.sort((a, b) => {
                const dateA = new Date(a.date || a.timestamp || 0);
                const dateB = new Date(b.date || b.timestamp || 0);
                return dateB - dateA;
            });
            
            console.log("üìÇ Discussions charg√©es:", orders);

            listContainer.innerHTML = '';
            
            if (orders.length === 0) {
                listContainer.innerHTML = `
                    <div class="status-item active" style="padding: 20px; opacity: 0.7;">
                        <div class="status-text">
                            <strong>Aucune discussion</strong>
                            <small>Vos commandes et discussions appara√Ætront ici.</small>
                        </div>
                    </div>
                `;
                return;
            }

            orders.forEach((order, index) => {
                const item = document.createElement('div');
                item.className = 'status-item active conversation-item';
                item.style.cursor = 'pointer';
                item.style.marginBottom = '15px';
                item.style.padding = '15px';
                item.style.background = 'rgba(255,255,255,0.05)';
                item.style.borderRadius = '12px';
                item.style.transition = 'all 0.2s';
                
                const dateObj = new Date(order.date || order.timestamp);
                const dateStr = isNaN(dateObj) ? 'Date inconnue' : dateObj.toLocaleDateString();
                const itemCount = order.items ? order.items.length : 0;
                const status = order.status || 'pending';
                const statusIcon = status === 'completed' || status === 'delivered' ? '‚úÖ' : '‚è≥';
                
                item.innerHTML = `
                    <div class="status-icon" style="background: rgba(0, 212, 255, 0.1);">üí¨</div>
                    <div class="status-text" style="flex: 1;">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${statusIcon} Commande #${order.orderNumber || order.order_id}</strong>
                            <span style="font-size:12px; opacity:0.6;">${dateStr}</span>
                        </div>
                        <small>${itemCount} article(s) ‚Ä¢ ${status.toUpperCase()}</small>
                    </div>
                `;

                const orderId = order.orderNumber || order.order_id;
                item.onclick = () => loadChat(orderId, item);
                listContainer.appendChild(item);

                // Auto load logic
                const urlParams = new URLSearchParams(window.location.search);
                const targetOrder = urlParams.get('chat_order');
                
                if (targetOrder && orderId === targetOrder) {
                    loadChat(orderId, item, true); // True to force view switch on mobile if needed
                } 
                else if (!targetOrder && index === 0 && window.innerWidth > 900) { 
                    loadChat(orderId, item, false);
                }
            });
        }

        let currentChat = null;

        function loadChat(orderId, element, switchView = true) {
            // Trigger Mobile View
            if (switchView) {
                document.querySelector('.success-grid').classList.add('mobile-chat-active');
            }

            // Update UI selection
            document.querySelectorAll('.conversation-item').forEach(el => {
                el.style.border = '1px solid transparent';
                el.style.background = 'rgba(255,255,255,0.05)';
            });
            if(element) {
                element.style.borderColor = 'var(--electric-blue)';
                element.style.background = 'rgba(0, 212, 255, 0.1)';
            }

            document.getElementById('chatActiveOrder').textContent = `Commande #${orderId}`;
            
            // Clean up previous chat instance if needed (though OrderChat doesn't have destroy method yet)
            // We just overwrite the DOM container, which kills the old event listeners effects effectively 
            // but the old polling interval might still run! 
            // TODO: Add stopPolling to OrderChat. For now, simple page navigation is expected use pattern, 
            // but here we are swapping. I should add a check in chat.js
            
            // Re-instantiate chat
            if (window.orderChat && window.orderChat.stopPolling) {
                window.orderChat.stopPolling();
            } else if (window.orderChat && window.orderChat.pollInterval) {
                 clearInterval(window.orderChat.pollInterval);
            }

            // Small delay to allow clean UI reset
            const container = document.getElementById('chat-dynamic-content');
            container.innerHTML = '<div class="spinner" style="margin: auto;"></div>';

            setTimeout(() => {
                 window.orderChat = new OrderChat(orderId, API_URL, 'chat-dynamic-content');
            }, 50);
        }
    </script>
    <style>
        /* Custom scrollbar for convos list */
        .conversations-list::-webkit-scrollbar {
            width: 6px;
        }
        .conversations-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        .conversations-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
    </style>
</body>
</html>
